#pragma config(I2C_Usage, I2C1, i2cSensors)
#pragma config(Sensor, in1,    lightSensor,    sensorReflection)
#pragma config(Sensor, in8,    towerPot,       sensorPotentiometer)
#pragma config(Sensor, dgtl1,  topButton,      sensorTouch)
#pragma config(Sensor, dgtl2,  ultrasonic,     sensorSONAR_cm)
#pragma config(Sensor, I2C_1,  ,               sensorQuadEncoderOnI2CPort,    , AutoAssign )
#pragma config(Sensor, I2C_2,  ,               sensorQuadEncoderOnI2CPort,    , AutoAssign )
#pragma config(Motor,  port1,           rightMotor,    tmotorVex393_HBridge, openLoop, reversed, encoderPort, I2C_1)
#pragma config(Motor,  port9,           towerMotor,    tmotorVex393_MC29, openLoop, reversed)
#pragma config(Motor,  port10,          leftMotor,     tmotorVex393_HBridge, openLoop, encoderPort, I2C_2)
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

#include "DriveBase.c"
#include "RobotStates.h"

void init();
void testPeriodic();
void cleanup();
void waitForButton();
void testLightSensor();

RobotState currentState = STATE_DISABLED;
float last[4];

task main() {
    init();
    waitForButton();

    last[0] = 0;
    last[1] = 0;
    last[2] = 0;
    last[3] = 0;

    while(currentState != STATE_DISABLED) {
        switch(currentState) {
        case STATE_ENABLED:
            currentState = STATE_TEST;
            writeDebugStreamLine("Inside Enabled switch block");
            break;
        case STATE_TEST:
            testPeriodic();
            writeDebugStreamLine("Inside test switch block");
            break;
         default:
            writeDebugStreamLine("Inside default switch block");
        }
        wait1Msec(1);
    }
    cleanup();
}

void init() {
    clearDebugStream();
    driveInit();
    wait1Msec(250);
}

void testPeriodic() {
    driveInit();
    arcTurn(30, 90, true, 20, 250);
    driveInit();
    driveStraight(100, 70, 20, 250);
    driveInit();
    arcTurn(30, 90, false, 20, 250);

    currentState = STATE_DISABLED;
}

// Prints the value of the light sensor in analog port 1.
void testLightSensor() {
    writeDebugStreamLine("Test periodic running.\n");
    writeDebugStreamLine("Value of light sensor: %d", SensorValue[lightSensor]);

    last[0] = last[1];
    last[1] = last[2];
    last[2] = last[3];
    last[3] = SensorValue[lightSensor];

    writeDebugStreamLine("Average of last 4: %f", (last[0] + last[1] + last[2] + last[3]) / 4);
}

// General cleanup and safety code
void cleanup() {

    motor[rightMotor] = 0;
    motor[leftMotor] = 0;
    motor[towerMotor] = 0;
    resetMotorEncoder(rightMotor);
    resetMotorEncoder(leftMotor);
}

// Changes the state to enabled after the button is pushed
void waitForButton() {
    while(!SensorValue(topButton)) {
        wait1Msec(5);
    }

    currentState = STATE_ENABLED;
}
